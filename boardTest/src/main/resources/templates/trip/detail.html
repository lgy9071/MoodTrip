<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title th:text="${plan.title} + ' - 상세'">여행 상세</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .header { display:flex; justify-content: space-between; align-items: center; }
    .muted { color:#666; }
    .btn { padding: 6px 10px; border:1px solid #ccc; background:#fff; cursor:pointer; text-decoration:none; border-radius:6px; }
    .btn-danger { background:#e74c3c; color:#fff; border-color:#e74c3c; }
    .btn-primary { background:#0064ff; color:#fff; border-color:#0064ff; }
    .wrap { display:grid; grid-template-columns: 1fr 420px; gap: 24px; margin-top:16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f5f7fa; }
    .row-actions { display:flex; gap:8px; }
    .err { color:#c22727; font-size: 0.9em; }
    input[type=text], input[type=number], textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; }
    textarea { min-height: 80px; }
    .msg { background:#ecf9f1; border:1px solid #b7ebc6; padding:8px; margin-top:12px; color:#18794e; }
  </style>
</head>
<body>

<div class="header">
  <div>
    <h1 th:text="${plan.title}">여행 제목</h1>
    <div class="muted" th:text="${plan.startDate} + ' ~ ' + ${plan.endDate}"></div>
  </div>
  <div style="display:flex; gap:8px;">
    <a class="btn" th:href="@{/trips}">목록</a>
    <div th:if="${session.LOGIN_USER != null
             and #ids.eq(session.LOGIN_USER.id, place.author?.id)}">
    <form th:action="@{|/trips/${plan.id}/delete|}" method="post" onsubmit="return confirm('정말 삭제하시겠습니까?');">
      <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>
      <button type="submit" class="btn btn-danger">계획 삭제</button>
    </form>
    </div>
  </div>
</div>

<div th:if="${msg}" class="msg" th:text="${msg}"></div>

<div class="wrap">
  <!-- 좌측: 경유지 목록 -->
  <div>
    <h2>경유지 목록</h2>
    <table>
      <thead>
      <tr>
        <th style="width:80px;">일차</th>
        <th>장소명</th>
        <th>주소</th>
        <th>메모</th>
        <th style="width:180px;">액션</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="s : ${stops}">
        <td th:text="${s.dayOrder}"></td>
        <td th:text="${s.placeName}"></td>
        <td th:text="${s.address} ?: '-'"></td>
        <td th:text="${s.memo} ?: '-'"></td>
        <td class="row-actions">
          <button class="btn" th:attr="data-id=${s.id}" onclick="moveDay(this, -1)">-1일</button>
          <button class="btn" th:attr="data-id=${s.id}" onclick="moveDay(this, 1)">+1일</button>
          <div th:if="${session.LOGIN_USER != null
             and #ids.eq(session.LOGIN_USER.id, place.author?.id)}">
          <button class="btn btn-danger" th:attr="data-id=${s.id}" onclick="removeStop(this)">삭제</button>
          </div>
        </td>
      </tr>
      <tr th:if="${#lists.isEmpty(stops)}">
        <td colspan="5" style="text-align:center;color:#888;">경유지가 없습니다.</td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- 우측: 경유지 추가 폼 -->
  <div>
    <h2>경유지 추가</h2>
    <form th:action="@{|/trips/${plan.id}/stops|}" method="post" th:object="${stopForm}">
      <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>
      <div style="display:grid; gap:12px;">
        <div>
          <label>일차</label>
          <input type="number" min="1" th:field="*{dayOrder}" />
          <div class="err" th:if="${#fields.hasErrors('dayOrder')}" th:errors="*{dayOrder}"></div>
        </div>
        <div>
          <label>장소명</label>
          <input type="text" th:field="*{placeName}" placeholder="예) 도톤보리"/>
          <div class="err" th:if="${#fields.hasErrors('placeName')}" th:errors="*{placeName}"></div>
        </div>
        <div>
          <label>주소(선택)</label>
          <input type="text" th:field="*{address}" placeholder="예) 오사카부 오사카시…"/>
        </div>
        <div>
          <label>메모</label>
          <textarea th:field="*{memo}" placeholder="추천 메뉴, 입장시간 등"></textarea>
        </div>
        <div>
          <button class="btn btn-primary" type="submit">추가</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script th:inline="javascript">
  async function removeStop(btn) {
    const id = btn.getAttribute('data-id');
    if (!confirm('삭제하시겠습니까?')) return;
    const tokenName = /*[[${_csrf?.parameterName}]]*/ '_csrf';
    const tokenValue = /*[[${_csrf?.token}]]*/ '';
    const res = await fetch(`/trips/stops/${id}`, {
      method: 'DELETE',
      headers: { 'X-Requested-With': 'XMLHttpRequest', ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {}) }
    });
    if (res.ok) location.reload();
    else alert('삭제 실패');
  }

  async function moveDay(btn, delta) {
    const id = btn.getAttribute('data-id');
    const tokenValue = /*[[${_csrf?.token}]]*/ '';
    // 서버에서 기존 day를 모르니, 간단히 delta만 요청하고 서버는 newDay 파라미터를 요구 -> 현재 화면에서 계산 불가하므로
    // UX 단순화를 위해 입력창 띄우기:
    const newDay = prompt('변경할 일차를 입력하세요(숫자):');
    if (!newDay) return;
    const params = new URLSearchParams({ newDay });
    const res = await fetch(`/trips/stops/${id}/day?` + params, {
      method: 'PATCH',
      headers: { 'X-Requested-With': 'XMLHttpRequest', ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {}) }
    });
    if (res.ok) location.reload();
    else alert('이동 실패');
  }
</script>

</body>
</html>