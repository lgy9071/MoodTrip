<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${plan.title} + ' - 상세'">여행 상세</title>
    <link rel="stylesheet" th:href="@{/css/base.css}" />

    <!-- ★ Booking.com 스타일 전용 CSS -->
    <style>
        /* 전체 레이아웃 */
        body { background:#f5f6f7; }

        .bk-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 28px;
        }
        @media(max-width: 960px){
            .bk-container { grid-template-columns: 1fr; }
        }

        /* 상단 여행 정보 카드 */
        .bk-trip-header {
            background:#fff;
            border:1px solid #d9d9d9;
            padding:22px;
            border-radius:6px;
            box-shadow:0 1px 3px rgba(0,0,0,0.08);
            margin-bottom:28px;
        }
        .bk-trip-header h1 {
            font-size:28px;
            font-weight:700;
            margin-bottom:6px;
        }

        /* 경유지 리스트 제목 */
        .bk-section-title {
            font-size:22px;
            font-weight:700;
            margin-bottom:18px;
        }

        /* 총 비용 박스 */
        .bk-summary {
            background:#eef7ff;
            border:1px solid #c8e0ff;
            padding:16px;
            border-radius:6px;
            margin-bottom:18px;
            font-size:16px;
        }

        /* ★ Stop 카드 (Booking 호텔 카드 느낌) */
        .bk-stop-card {
            background:#fff;
            border-radius:6px;
            border:1px solid #e0e0e0;
            padding:18px;
            display:flex;
            gap:20px;
            margin-bottom:18px;
            box-shadow:0 1px 2px rgba(0,0,0,0.05);
        }
        .bk-stop-img {
            width:150px;
            height:120px;
            border-radius:6px;
            object-fit:cover;
            background:#eee;
        }
        .bk-stop-info {
            flex:1;
        }
        .bk-stop-info .place {
            font-size:18px;
            font-weight:700;
            margin-bottom:3px;
        }
        .bk-stop-info .address {
            color:#666;
            margin-bottom:6px;
        }
        .bk-stop-info .memo {
            margin-bottom:10px;
        }
        .bk-stop-actions {
            display:flex;
            flex-direction:column;
            gap:6px;
            align-items:flex-end;
        }

        /* 오른쪽 폼 박스 */
        .bk-form-box {
            background:#fff;
            border:1px solid #d8d8d8;
            padding:22px;
            border-radius:6px;
            box-shadow:0 1px 3px rgba(0,0,0,0.07);
        }
        .bk-form-box h2 {
            font-size:20px;
            font-weight:700;
            margin-bottom:16px;
        }

        /* 공통 form row */
        .bk-row { margin-bottom:14px; }
        .bk-row label { display:block; margin-bottom:6px; font-weight:600; }
        .bk-row input, .bk-row select {
            width:100%;
            padding:8px 10px;
            border:1px solid #ccc;
            border-radius:4px;
        }

        /* 버튼 스타일 */
        .btn-primary {
            background:#0058a3 !important;
            color:white;
        }
        .btn-primary:hover {
            background:#004b8c !important;
        }

        /* 수정 모달 */
        #editStopModal {
            display:none; position:fixed; inset:0;
            background:rgba(0,0,0,.35); z-index:9999;
        }
        .modal__dialog {
            background:#fff; width:520px;
            margin:10vh auto; border-radius:8px;
            box-shadow:0 10px 30px rgba(0,0,0,.2);
            overflow:hidden;
        }
        .modal__header {
            padding:14px 16px;
            border-bottom:1px solid #ddd;
            display:flex; justify-content:space-between;
        }
        .modal__body { padding:18px; }
    </style>
</head>


<body>
<div th:replace="~{fragments/header :: siteHeader('trips')}"></div>

<main class="wrap">

    <!-- 상단 여행 요약 -->
    <div class="bk-trip-header">
        <h1 th:text="${plan.title}"></h1>
        <div class="muted" th:text="${plan.startDate} + ' ~ ' + ${plan.endDate}"></div>
        <div class="muted">
            작성자: <b th:text="${plan.owner?.name ?: '알 수 없음'}"></b>
        </div>

        <div style="margin-top:12px;">
            <a class="btn" th:href="@{/trips}">← 목록으로</a>

            <form th:if="${isOwner}" th:action="@{|/trips/${plan.id}/delete|}"
                  method="post" style="display:inline-block;"
                  onsubmit="return confirm('삭제하시겠습니까?');">
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
                <button class="btn btn-danger">삭제</button>
            </form>
        </div>
    </div>

    <!-- 본문 : 좌측 리스트 + 우측 폼 -->
    <div class="bk-container">

        <!-- 좌측: 경유지 목록 -->
        <section>
            <h2 class="bk-section-title">경유지 목록</h2>

            <div class="bk-summary">
                총 비용: <b th:text="${totalCost}"></b> 원
            </div>

            <!-- stop 리스트 -->
            <div th:each="s : ${stops}" class="bk-stop-card">

                <img th:if="${s.imageUrl}" th:src="${s.imageUrl}" class="bk-stop-img">

                <div class="bk-stop-info">
                    <div class="place" th:text="${s.placeName}"></div>
                    <div class="address" th:text="${s.address ?: '-'}"></div>
                    <div class="memo" th:text="${s.memo ?: '-'}"></div>

                    <div>
                        <b th:text="${s.dayOrder}"></b>일차 ·
                        비용 <b th:text="${#numbers.formatDecimal(s.cost,0,'COMMA',0,'POINT')}"></b> 원
                    </div>
                </div>

                <div class="bk-stop-actions" th:if="${isOwner}">
                    <button class="btn btn-primary"
                            onclick="openEditStop(this)"
                            th:attr="data-id=${s.id},
                                 data-day=${s.dayOrder},
                                 data-place=${s.placeName},
                                 data-address=${s.address},
                                 data-memo=${s.memo},
                                 data-cost=${s.cost}">
                        수정
                    </button>

                    <button class="btn btn-danger"
                            th:attr="data-id=${s.id}"
                            onclick="removeStop(this)">
                        삭제
                    </button>
                </div>
            </div>
        </section>

        <!-- 우측: 경유지 추가 폼 -->
        <section>
            <div class="bk-form-box">
                <h2>경유지 추가</h2>

                <form th:if="${isOwner}"
                      th:action="@{|/trips/${plan.id}/stops|}"
                      th:object="${stopForm}"
                      method="post" enctype="multipart/form-data">

                    <div class="bk-row">
                        <label>일차</label>
                        <input type="number" th:field="*{dayOrder}" min="1"/>
                    </div>

                    <div class="bk-row">
                        <label>장소명</label>
                        <input type="text" th:field="*{placeName}" placeholder="예) 도톤보리"/>
                    </div>

                    <div class="bk-row">
                        <label>주소</label>
                        <input type="text" th:field="*{address}"/>
                    </div>

                    <div class="bk-row">
                        <label>메모</label>
                        <input type="text" th:field="*{memo}"/>
                    </div>

                    <div class="bk-row">
                        <label>비용</label>
                        <input type="number" th:field="*{cost}" min="0" step="0.01"/>
                    </div>

                    <div class="bk-row">
                        <label>분류</label>
                        <select th:field="*{category}">
                            <option th:each="c : ${categories}" th:value="${c}" th:text="${c}"></option>
                        </select>
                    </div>

                    <div class="bk-row">
                        <label>이미지</label>
                        <input type="file" th:field="*{image}"/>
                    </div>

                    <button class="btn btn-primary" style="width:100%; margin-top:10px;">+ 경유지 추가</button>

                </form>

                <div th:if="${!isOwner}" class="muted">읽기 전용입니다.</div>
            </div>
        </section>

    </div>
</main>

<div th:replace="~{fragments/footer :: siteFooter}"></div>

<!-- 수정 모달 -->
<div id="editStopModal" class="modal">
    <div class="modal__dialog">
        <div class="modal__header">
            <strong>경유지 수정</strong>
            <button type="button" class="btn" onclick="closeEditStop()">닫기</button>
        </div>

        <form id="editStopForm" class="modal__body" onsubmit="saveEditStop(event)">
            <input type="hidden" name="id" />

            <div class="bk-row">
                <label>일차</label>
                <input type="number" name="dayOrder" min="1" required />
            </div>

            <div class="bk-row">
                <label>장소명</label>
                <input type="text" name="placeName" required />
            </div>

            <div class="bk-row">
                <label>주소(선택)</label>
                <input type="text" name="address"/>
            </div>

            <div class="bk-row">
                <label>메모</label>
                <input type="text" name="memo"/>
            </div>

            <div class="bk-row">
                <label>비용(원)</label>
                <input type="number" name="cost" step="0.01" min="0"/>
            </div>

            <div style="margin-top:14px; text-align:right;">
                <button type="button" class="btn" onclick="closeEditStop()">취소</button>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>
</div>


<!-- JS -->
<script th:inline="javascript">

    /* 삭제 */
    async function removeStop(btn) {
      const id = btn.getAttribute('data-id');
      if (!confirm('삭제하시겠습니까?')) return;
      const tokenValue = /*[[${_csrf?.token}]]*/ '';
      const res = await fetch(`/api/trips/stops/${id}`, {
        method: 'DELETE',
        headers: { 'X-Requested-With': 'XMLHttpRequest', ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {}) }
      });
      if (res.ok) location.reload();
      else alert('삭제 실패');
    }

    /* 수정 모달 */
    const modal = document.getElementById('editStopModal');
    const form  = document.getElementById('editStopForm');

    function openEditStop(btn) {
      const ds = btn.dataset;
      form.id.value        = ds.id;
      form.dayOrder.value  = ds.day;
      form.placeName.value = ds.place || '';
      form.address.value   = ds.address || '';
      form.memo.value      = ds.memo || '';
      form.cost.value      = ds.cost || '';
      modal.style.display = 'block';
    }
    function closeEditStop() { modal.style.display = 'none'; }
    modal.addEventListener('click', e => { if (e.target === modal) closeEditStop(); });

    /* 수정 저장 */
    async function saveEditStop(e) {
      e.preventDefault();
      const id   = form.id.value;

      const body = {
        dayOrder:  Number(form.dayOrder.value),
        placeName: form.placeName.value.trim(),
        address:   form.address.value.trim() || null,
        memo:      form.memo.value.trim() || null,
        cost:      form.cost.value === '' ? null : Number(form.cost.value)
      };

      if (!body.placeName) { alert('장소명을 입력하세요.'); return; }

      const tokenValue = /*[[${_csrf?.token}]]*/ '';

      const res = await fetch(`/api/trips/stops/${id}`, {
        method:'PUT',
        headers:{
          'Content-Type':'application/json',
          'X-Requested-With':'XMLHttpRequest',
          ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {})
        },
        body: JSON.stringify(body)
      });

      if (res.ok) { closeEditStop(); location.reload(); }
      else alert('수정 실패');
    }
</script>

</body>
</html>
