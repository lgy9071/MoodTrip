<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>여행 계획 목록</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 24px; }
        .top { display:flex; justify-content: space-between; align-items:center; }
        table { border-collapse: collapse; width: 100%; margin-top: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f5f7fa; }
        .pagination { margin-top: 12px; display:flex; gap:8px; }
        .btn { padding: 6px 10px; border:1px solid #ccc; background:#fff; cursor:pointer; text-decoration:none; }
        .btn-primary { background:#0064ff; color:white; border-color:#0064ff; }
        .msg { background:#ecf9f1; border:1px solid #b7ebc6; padding:8px; margin-top:12px; color:#18794e; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: siteHeader('trips')}"></div>

<main style="padding:16px 0;">
    <div class="top">
        <h1>여행 계획</h1>

        <!-- 비로그인일 때: 모달 띄운 뒤 이동 -->
        <a class="btn btn-primary"
           th:if="${session.LOGIN_USER == null}"
           href="#"
           onclick="openLoginModal(event)">+ 새 계획</a>

        <!-- 로그인 상태일 때: 그대로 새 계획으로 -->
        <a class="btn btn-primary"
           th:if="${session.LOGIN_USER != null}"
           th:href="@{/trips/new}">+ 새 계획</a>
    </div>

    <div th:if="${msg}" class="msg" th:text="${msg}"></div>
    <div th:if="${error}" class="msg" style="background:#ffecec;border-color:#ffb4b4;color:#a40000" th:text="${error}"></div>

    <table>
        <thead>
        <tr>
            <th>#</th>
            <th>제목</th>
            <th>기간</th>
            <th>작성자</th>
            <th>작성일</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="p, i : ${plans.content}">
            <!-- 번호: 페이지 내 1,2,3… 이면 i.count / 전체 역순이면 아래 주석-->
            <td th:text="${i.count}"></td>
            <!-- 전체 역순 : th:text="${plans.totalElements - (plans.number * plans.size) - i.index}" -->

            <td><a th:href="@{|/trips/${p.id}|}" th:text="${p.title}"></a></td>
            <td th:text="${p.startDate} + ' ~ ' + ${p.endDate}"></td>

            <!-- 작성자 출력 -->
            <td th:text="${p.owner != null && p.owner.name != null ? p.owner.name : (p.owner != null ? p.owner.username : '-')}"></td>

            <!-- createdAt null-safe -->
            <td th:text="${p.createdAt != null ? #temporals.format(p.createdAt, 'yyyy-MM-dd HH:mm') : '-'}"></td>
        </tr>
        <tr th:if="${plans.content.size()==0}">
            <td colspan="5" style="text-align:center;color:#888;">등록된 여행 계획이 없습니다.</td>
        </tr>
        </tbody>
    </table>

    <div class="pagination">
        <a class="btn" th:if="${!plans.first}" th:href="@{/trips(page=${plans.number-1}, size=${plans.size})}">이전</a>
        <span th:text="${plans.number + 1} + ' / ' + ${plans.totalPages}">1 / 1</span>
        <a class="btn" th:if="${!plans.last}" th:href="@{/trips(page=${plans.number+1}, size=${plans.size})}">다음</a>
    </div>
</main>

<div th:replace="~{fragments/footer :: siteFooter}"></div>

<!-- SweetAlert2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function openLoginModal(e) {
      e.preventDefault();

      // Swal이 안 뜨는 환경 대비: 기본 confirm으로 폴백
      if (typeof Swal === 'undefined') {
        if (confirm('로그인이 필요합니다.\n로그인하시겠습니까?')) {
          window.location.href = '/login?next=/trips/new';
        }
        return;
      }

      Swal.fire({
        title: '로그인이 필요합니다',
        text: '로그인하시겠습니까?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '로그인하기',
        cancelButtonText: '취소',
        reverseButtons: true,
        focusConfirm: false
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = '/login?next=/trips/new';
        }
      });
    }
</script>
</body>
</html>
