<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${plan.title} + ' - 상세'">여행 상세</title>
    <link rel="stylesheet" th:href="@{/css/base.css}" />
    <style>
        /* 모달 기본 스타일 */
        #editStopModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999; }
        #editStopModal .dialog {
          background:#fff; width:520px; max-width:calc(100% - 24px);
          margin:10vh auto; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15); overflow:hidden;
        }
        #editStopModal .dialog-header {
          padding:14px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;
        }
        #editStopModal .dialog-body { padding:16px; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: siteHeader('trips')}"></div>

<main class="wrap">

    <div class="page-header between">
        <div>
            <h1 th:text="${plan.title}"></h1>
            <div class="muted" th:text="${plan.startDate} + ' ~ ' + ${plan.endDate}"></div>
            <div class="muted">
                작성자: <span th:text="${plan.owner?.name ?: '알 수 없음'}"></span>
            </div>
        </div>

        <div>
            <a class="btn" th:href="@{/trips}">목록</a>
            <form th:if="${isOwner}" th:action="@{|/trips/${plan.id}/delete|}" method="post"
                  onsubmit="return confirm('삭제하시겠습니까?');">
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
                <button class="btn btn-danger">삭제</button>
            </form>
        </div>
    </div>

    <div class="grid-2col gap-20">

        <!-- 좌측: 경유지 카드 리스트 -->
        <section>
            <h2>경유지 목록</h2>

            <div class="summary-box">
                총 비용:
                <b th:text="${formattedTotalCost}"></b> 원
            </div>

            <div th:each="s : ${stops}" class="stop-card">
                <div class="stop-card__day">
                    <b th:text="${s.dayOrder} + '일차'"></b>
                </div>

                <div class="stop-card__content">
                    <div class="title" th:text="${s.placeName}"></div>
                    <div class="address" th:text="${s.address ?: '-'}"></div>
                    <div class="memo" th:text="${s.memo ?: '-'}"></div>
                    <div class="cost">
                        비용:
                        <b th:text="${#numbers.formatDecimal(s.cost,0,'COMMA',0,'POINT')}"></b> 원
                    </div>

                    <img th:if="${s.imageUrl}" th:src="${s.imageUrl}" class="stop-image">
                </div>

                <div class="stop-card__actions" th:if="${isOwner}">
                    <button class="btn" onclick="openEditStop(this)"
                            th:attr="data-id=${s.id}, data-day=${s.dayOrder}, data-place=${s.placeName}">수정</button>

                    <button class="btn btn-danger"
                            th:attr="data-id=${s.id}"
                            onclick="removeStop(this)">삭제</button>
                </div>
            </div>

        </section>

        <!-- 우측: 추가 폼 -->
        <section>
            <h2>경유지 추가</h2>

            <div class="section-card">
                <form th:if="${isOwner}"
                      th:action="@{|/trips/${plan.id}/stops|}"
                      method="post"
                      enctype="multipart/form-data"
                      th:object="${stopForm}">

                    <!-- ...입력필드 동일 (깔끔한 CSS로 정리만) -->

                </form>

                <div th:if="${!isOwner}" class="muted">읽기 전용입니다.</div>
            </div>
        </section>
    </div>
</main>


<div th:replace="~{fragments/footer :: siteFooter}"></div>

<!-- 수정 모달 -->
<div id="editStopModal" class="modal">
    <div class="modal__dialog">
        <div class="modal__header">
            <strong>경유지 수정</strong>
            <button type="button" class="btn" onclick="closeEditStop()">닫기</button>
        </div>
        <form id="editStopForm" class="modal__body" onsubmit="saveEditStop(event)">
            <input type="hidden" name="id" />
            <div class="grid">
                <div class="form-row">
                    <label>일차</label>
                    <input type="number" name="dayOrder" min="1" required />
                </div>
                <div class="form-row">
                    <label>장소명</label>
                    <input type="text" name="placeName" required placeholder="예) 도톤보리"/>
                </div>
                <div class="form-row">
                    <label>주소(선택)</label>
                    <input type="text" name="address" placeholder="예) 오사카부 오사카시…"/>
                </div>
                <div class="form-row">
                    <label>메모</label>
                    <textarea name="memo" placeholder="추천 메뉴, 입장시간 등" style="min-height:80px;"></textarea>
                </div>
                <div class="form-row">
                    <label>비용(원)</label>
                    <input type="number" name="cost" step="0.01" min="0" placeholder="예) 12000"/>
                </div>
                <div class="top" style="justify-content:flex-end;">
                    <button type="button" class="btn" onclick="closeEditStop()">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script th:inline="javascript">
    async function removeStop(btn) {
      const id = btn.getAttribute('data-id');
      if (!confirm('삭제하시겠습니까?')) return;
      const tokenValue = /*[[${_csrf?.token}]]*/ '';
      const res = await fetch(`/api/trips/stops/${id}`, { // <- /api 로 수정
        method: 'DELETE',
        headers: { 'X-Requested-With': 'XMLHttpRequest', ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {}) }
      });
      if (res.ok) location.reload();
      else alert('삭제 실패');
    }

    const modal = document.getElementById('editStopModal');
    const form  = document.getElementById('editStopForm');

    function openEditStop(btn) {
      const ds = btn.dataset;
      form.id.value        = ds.id;
      form.dayOrder.value  = ds.day;
      form.placeName.value = ds.place || '';
      form.address.value   = ds.address || '';
      form.memo.value      = ds.memo || '';
      form.cost.value      = (ds.cost !== undefined && ds.cost !== null) ? ds.cost : '';
      modal.style.display = 'block';
    }
    function closeEditStop() { modal.style.display = 'none'; }
    modal?.addEventListener('click', (e) => { if (e.target === modal) closeEditStop(); });

    async function saveEditStop(e) {
      e.preventDefault();
      const id   = form.id.value;
      const body = {
        dayOrder:  Number(form.dayOrder.value),
        placeName: form.placeName.value?.trim(),
        address:   form.address.value?.trim() || null,
        memo:      form.memo.value?.trim() || null,
        cost:      form.cost.value === '' ? null : Number(form.cost.value)
      };
      if (!body.placeName) { alert('장소명을 입력해주세요.'); return; }
      if (!body.dayOrder || body.dayOrder < 1) { alert('일차는 1 이상의 숫자여야 합니다.'); return; }

      const tokenValue = /*[[${_csrf?.token}]]*/ '';
      try {
        const res = await fetch(`/api/trips/stops/${id}`, { // 실제 PUT 엔드포인트 구현 시 /api로 맞추세요
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {})
          },
          body: JSON.stringify(body)
        });
        if (res.ok) { closeEditStop(); location.reload(); }
        else { const msg = await res.text(); alert('수정 실패: ' + (msg || res.status)); }
      } catch (err) {
        console.error(err);
        alert('네트워크 오류로 수정에 실패했습니다.');
      }
    }

    (function() {
      const labels = /*[[${catLabels}]]*/ [];
      const rawValues = /*[[${catValues}]]*/ [];
      const values = Array.isArray(rawValues) ? rawValues.map(v => Number(v) || 0) : [];
      const el = document.getElementById('costChart');
      if (!el) return;

      const total = values.reduce((a,b)=>a+b, 0);
      if (total === 0) {
        const msg = document.createElement('div');
        msg.className = 'muted';
        msg.style.marginTop = '8px';
        msg.textContent = '카테고리별 비용 데이터가 없습니다.';
        el.replaceWith(msg);
        return;
      }

      const colors = ['#4C6EF5','#20C997','#FD7E14','#845EF7','#E64980','#868E96'];
      const ringShadow = {
        id: 'ringShadow',
        afterDatasetsDraw(chart) {
          const {ctx, chartArea: {top, bottom, left, right}} = chart;
          ctx.save();
          ctx.shadowColor = 'rgba(0,0,0,0.18)';
          ctx.shadowBlur = 12; ctx.shadowOffsetY = 6;
          const x = (left + right)/2, y = (top + bottom)/2;
          const outerR = Math.min(right-left, bottom-top)/2 * 0.95;
          ctx.beginPath(); ctx.arc(x, y, outerR, 0, Math.PI*2);
          ctx.strokeStyle = 'rgba(0,0,0,0.08)'; ctx.lineWidth = 4; ctx.stroke();
          ctx.restore();
        }
      };

      const ctx = el.getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderColor:'#fff', borderWidth:2, hoverOffset:8 }] },
        options: {
          layout: { padding: 0 }, cutout:'74%', radius:'78%',
          plugins: {
            legend: { position:'bottom', labels:{ usePointStyle:true, pointStyle:'circle' } },
            tooltip: { callbacks: {
              label: (c) => {
                const v = Number(c.parsed) || 0;
                const isInt = Number.isInteger(v);
                const f = isInt ? v.toLocaleString() : v.toLocaleString(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 });
                return `${c.label}: ${f}원`;
              }
            }}
          }, animation: { animateRotate:true, duration:600 }
        },
        plugins: [ringShadow]
      });
    })();
</script>
</body>
</html>
