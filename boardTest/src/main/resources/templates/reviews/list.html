<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¦¬ë·° ëª©ë¡</title>
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <style>
        .like-btn {
          border: none;
          background: none;
          cursor: pointer;
          font-size: 1.2rem;
          transition: 0.2s;
        }
        .like-btn.liked {
          color: #ff6464;
          transform: scale(1.2);
        }
        .delete-form {
            display: inline;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: siteHeader('reviews')}"></div>

<main class="wrap">
    <div class="top">
        <h1>ë¦¬ë·° ëª©ë¡</h1>
        <div class="filters">
            <form method="get" action="/reviews" style="display:flex; gap:8px; align-items:center;">
                <select name="category">
                    <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                    <option value="movie" th:selected="${category == 'movie'}">ì˜í™”</option>
                    <option value="trip" th:selected="${category == 'trip'}">ì—¬í–‰</option>
                    <option value="place" th:selected="${category == 'place'}">ë§›ì§‘</option>
                </select>

                <select name="sort">
                    <option value="latest" th:selected="${sort == 'latest'}">ìµœì‹ ìˆœ</option>
                    <option value="ratingDesc" th:selected="${sort == 'ratingDesc'}">í‰ì  ë†’ì€ìˆœ</option>
                    <option value="ratingAsc" th:selected="${sort == 'ratingAsc'}">í‰ì  ë‚®ì€ìˆœ</option>
                </select>

                <label>
                    <input type="checkbox" name="mine" th:checked="${mine}" value="true"> ë‚´ ë¦¬ë·°ë§Œ
                </label>

                <button type="submit" class="btn btn-primary">ì ìš©</button>
            </form>
            <a href="/reviews/new" class="btn btn-secondary">ë¦¬ë·° ì‘ì„±</a>
        </div>
    </div>

    <div class="card-container">
        <div class="card" th:each="r : ${reviewPage.content}">
            <div class="card-body">
                <h3><a th:href="@{/reviews/{id}(id=${r.id})}" th:text="${r.title}"></a></h3>
                <p><b>ì‘ì„±ì:</b> <span th:text="${r.authorName}"></span></p>
                <p><b>í‰ì :</b> <span th:text="${r.rating}"></span></p>
                <p><b>ì¢‹ì•„ìš”:</b>
                    <button type="button" class="like-btn" th:data-id="${r.id}" th:id="'likeBtn-' + ${r.id}">ğŸ‘</button>
                    <span th:id="'likeCount-' + ${r.id}" th:text="${r.likeCount}">0</span>
                </p>

                <div th:if="${session.LOGIN_USER != null and session.LOGIN_USER.username == r.authorName}">
                    <form th:action="@{/reviews/{id}/delete(id=${r.id})}" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-danger"
                                onclick="return confirm('ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                    </form>
                </div>

                <p class="muted" th:text="${#temporals.format(r.createdAt,'yyyy-MM-dd')}"></p>
            </div>
        </div>
    </div>

    <div class="pagination">
        <span th:each="i : ${#numbers.sequence(0, totalPages-1)}">
            <a th:if="${i != currentPage}" th:href="@{/reviews(page=${i})}" th:text="${i+1}"></a>
            <span th:if="${i == currentPage}" th:text="${i+1}"></span>
        </span>
    </div>
</main>

<div th:replace="~{fragments/footer :: siteFooter}"></div>

<script>
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const res = await fetch(`/reviews/${id}/like`, { method: 'POST' });

            if (res.status === 401) {
                alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const data = await res.json();
            const countSpan = document.getElementById(`likeCount-${id}`);

            countSpan.textContent = data.likeCount;
            btn.classList.toggle('liked', data.liked);
            btn.textContent = data.liked ? 'ğŸ’–' : 'ğŸ‘';
        });
    });
</script>
</body>
</html>
