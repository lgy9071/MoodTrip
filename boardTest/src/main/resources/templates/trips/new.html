<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>여행 계획 등록</title>
    <link rel="stylesheet" th:href="@{/css/base.css}" />

    <style>
        body { background:#f5f6f7; }

        /* 상단 박스 */
        .bk-header-box {
            background:#fff;
            padding:24px;
            border:1px solid #d8d8d8;
            border-radius:6px;
            margin-bottom:26px;
            box-shadow:0 1px 3px rgba(0,0,0,0.08);
        }
        .bk-header-box h1 {
            font-size:26px;
            font-weight:700;
        }

        /* Booking 입력 카드 */
        .bk-form-card{
            background:#fff;
            border-radius:6px;
            border:1px solid #dadada;
            padding:22px;
            margin-bottom:26px;
            box-shadow:0 1px 3px rgba(0,0,0,0.05);
        }
        .bk-form-title{
            font-size:20px;
            font-weight:700;
            margin-bottom:14px;
        }

        /* form row */
        .bk-row{ margin-bottom:18px; }
        .bk-row label{
            display:block;
            margin-bottom:6px;
            font-weight:600;
        }
        .bk-row input, .bk-row select{
            width:100%;
            padding:9px 12px;
            border:1px solid #ccc;
            border-radius:4px;
        }

        /* Stop card */
        .bk-stop-table-header{
            font-weight:700;
            margin:18px 0;
            display:grid;
            grid-template-columns: 90px 1fr 140px 1fr 1fr 140px 80px;
            gap:10px;
        }
        .bk-stop-row{
            background:#fff;
            border:1px solid #e0e0e0;
            border-radius:6px;
            padding:12px;
            display:grid;
            grid-template-columns: 90px 1fr 140px 1fr 1fr 140px 80px;
            gap:10px;
            margin-bottom:12px;
            align-items:center;
        }

        /* 버튼 */
        .btn-primary { background:#0058a3 !important; color:white; }
        .btn-primary:hover{ background:#004c8d !important; }
    </style>

</head>
<body>

<div th:replace="~{fragments/header :: siteHeader('trips')}"></div>

<main class="wrap">

    <!-- 상단 -->
    <div class="bk-header-box">
        <h1>여행 계획 등록</h1>
    </div>

    <!-- 여행 기본 정보 -->
    <div class="bk-form-card">
        <div class="bk-form-title">기본 정보</div>

        <form th:action="@{/trips}" method="post" th:object="${form}" enctype="multipart/form-data">
            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

            <div class="grid" style="grid-template-columns:1fr 1fr 1fr; gap:20px;">

                <div class="bk-row">
                    <label>제목</label>
                    <input type="text" th:field="*{title}" placeholder="예) 오사카 2박 3일"/>
                </div>

                <div class="bk-row">
                    <label>시작일</label>
                    <input type="date" th:field="*{startDate}"/>
                </div>

                <div class="bk-row">
                    <label>종료일</label>
                    <input type="date" th:field="*{endDate}"/>
                </div>
            </div>

            <!-- AI 자동 채움 영역 -->
            <div class="bk-form-card" style="margin-top:20px;">
                <div class="bk-form-title">AI 추천 옵션</div>

                <div class="grid" style="grid-template-columns:1fr 1fr 1fr 150px; gap:16px; align-items:end;">
                    <div class="bk-row">
                        <label>도시(선택)</label>
                        <input type="text" id="ai-city" placeholder="예) Osaka">
                    </div>
                    <div class="bk-row">
                        <label>테마(선택)</label>
                        <input type="text" id="ai-theme" placeholder="예) food / night-view / history">
                    </div>
                    <div class="bk-row">
                        <label>일일 예산(원)</label>
                        <input type="number" id="ai-budget" min="0" placeholder="예) 80000">
                    </div>

                    <button type="button" class="btn btn-primary" onclick="fillByAi()">AI 추천 적용</button>
                </div>
            </div>

            <!-- 초기 경유지 -->
            <div class="bk-form-card">
                <div class="bk-form-title">최초 경유지 추가</div>

                <button type="button" class="btn" onclick="addStop()">+ 경유지 추가</button>

                <div class="bk-stop-table-header">
                    <div>일차</div>
                    <div>장소명</div>
                    <div>비용</div>
                    <div>주소</div>
                    <div>메모</div>
                    <div>분류</div>
                    <div>액션</div>
                </div>

                <div id="stops-container">
                    <div class="bk-stop-row" th:each="s, iStat : *{stops}">
                        <input type="number" min="1" th:field="*{stops[__${iStat.index}__].dayOrder}"/>
                        <input type="text" th:field="*{stops[__${iStat.index}__].placeName}" />
                        <input type="number" min="0" step="0.01" th:field="*{stops[__${iStat.index}__].cost}"/>
                        <input type="text" th:field="*{stops[__${iStat.index}__].address}"/>
                        <input type="text" th:field="*{stops[__${iStat.index}__].memo}"/>
                        <select th:field="*{stops[__${iStat.index}__].category}">
                            <option th:each="c : ${categories}" th:value="${c}" th:text="${c}"></option>
                        </select>

                        <button type="button" class="btn btn-danger" onclick="removeStop(this)">삭제</button>
                    </div>
                </div>
            </div>

            <div class="top" style="margin-top:20px;">
                <button class="btn btn-primary" type="submit">등록</button>
                <a class="btn" th:href="@{/trips}">목록</a>
            </div>
        </form>
    </div>

</main>

<!-- 기존 JS 유지 -->
<script th:inline="javascript">
    let stopIndex = /*[[${form.stops != null ? form.stops.size() : 0}]]*/ 0;

    function addStop() {
      const container = document.getElementById("stops-container");

      const row = document.createElement("div");
      row.className = "bk-stop-row";

      row.innerHTML = `
        <input type="number" min="1" name="stops[${stopIndex}].dayOrder"/>
        <input type="text" name="stops[${stopIndex}].placeName"/>
        <input type="number" min="0" step="0.01" name="stops[${stopIndex}].cost"/>
        <input type="text" name="stops[${stopIndex}].address"/>
        <input type="text" name="stops[${stopIndex}].memo"/>
        <select name="stops[${stopIndex}].category">
            ${/*[[${#lists.join(categories, '')}]]*/''}
        </select>
        <button type="button" class="btn btn-danger" onclick="removeStop(this)">삭제</button>
      `;

      container.appendChild(row);
      stopIndex++;
    }

    function removeStop(btn) {
      btn.closest(".bk-stop-row").remove();
    }

    async function fillByAi(){
      const s = document.querySelector('input[name="startDate"]').value;
      const e = document.querySelector('input[name="endDate"]').value;
      if(!s || !e){
         alert("여행 기간 먼저 설정하세요.");
         return;
      }

      const body = {
        startDate: s,
        endDate: e,
        city: document.getElementById('ai-city').value || null,
        theme: document.getElementById('ai-theme').value || null,
        budgetPerDay: document.getElementById('ai-budget').value || null
      };

      try{
        const res = await fetch("/api/ai/trips/suggest-stops",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(body)
        });

        if(!res.ok) throw new Error();
        const items = await res.json();

        for(const it of items){
          addStop();
          const idx = stopIndex - 1;

          document.querySelector(`input[name="stops[${idx}].dayOrder"]`).value = it.dayOrder;
          document.querySelector(`input[name="stops[${idx}].placeName"]`).value = it.placeName;
          document.querySelector(`input[name="stops[${idx}].address"]`).value = it.address;
          document.querySelector(`input[name="stops[${idx}].memo"]`).value = it.memo;
          document.querySelector(`input[name="stops[${idx}].cost"]`).value = it.cost;

          const sel = document.querySelector(`select[name="stops[${idx}].category"]`);
          if(sel && it.category) sel.value = it.category;
        }

      }catch(e){
        alert("AI 추천 오류");
      }
    }
</script>

<div th:replace="~{fragments/footer :: siteFooter}"></div>

</body>
</html>
