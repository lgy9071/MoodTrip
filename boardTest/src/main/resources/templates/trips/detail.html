<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${plan.title} + ' - 상세'">여행 상세</title>
    <style>
        /* 모달 기본 스타일 */
        #editStopModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999; }
        #editStopModal .dialog {
          background:#fff; width:520px; max-width:calc(100% - 24px);
          margin:10vh auto; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15); overflow:hidden;
        }
        #editStopModal .dialog-header {
          padding:14px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;
        }
        #editStopModal .dialog-body { padding:16px; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: siteHeader('trips')}"></div>

<main style="padding:16px 0;">

    <!-- BigDecimal 상수 별칭 -->
    <div th:with="BDONE=${T(java.math.BigDecimal).ONE}, BDZERO=${T(java.math.BigDecimal).ZERO}">

        <div class="header">
            <div>
                <h1 th:text="${plan.title}">여행 제목</h1>
                <div class="muted" th:text="${plan.startDate} + ' ~ ' + ${plan.endDate}"></div>
                <!-- 작성자 표시 -->
                <div class="muted">
                    작성자:
                    <span th:text="${plan.owner != null && plan.owner.name != null ? plan.owner.name : (plan.owner != null ? plan.owner.username : '알 수 없음')}"></span>
                </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <a class="btn" th:href="@{/trips}">목록</a>
                <!-- 소유자만 계획 삭제 노출 -->
                <div th:if="${isOwner}">
                    <form th:action="@{|/trips/${plan.id}/delete|}" method="post"
                          onsubmit="return confirm('정말 삭제하시겠습니까?');" style="display:inline;">
                        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>
                        <button type="submit" class="btn btn-danger">계획 삭제</button>
                    </form>
                </div>
            </div>
        </div>

        <div th:if="${msg}" class="msg" th:text="${msg}"></div>

        <div class="wrap">
            <!-- 좌측: 경유지 목록 -->
            <div>
                <h2>경유지 목록</h2>

                <!-- 총 비용: .00이면 소수점 제거 -->
                <div class="muted" style="margin:6px 0 10px"
                     th:with="plain=${totalCost != null and totalCost.remainder(BDONE).compareTo(BDZERO)==0}">
                    총 비용:
                    <b th:text="${plain} ? ${#numbers.formatDecimal(totalCost,0,'COMMA',0,'POINT')}
                               : ${#numbers.formatDecimal(totalCost,0,'COMMA',2,'POINT')}"></b> 원
                </div>

                <table>
                    <thead>
                    <tr>
                        <th style="width:80px;">일차</th>
                        <th>장소명</th>
                        <th>주소</th>
                        <th>메모</th>
                        <th style="width:100px;">분류</th>
                        <th style="width:120px;">비용</th>
                        <!-- 소유자일 때만 액션 컬럼 헤더 자체 렌더 -->
                        <th style="width:180px;" th:if="${isOwner}">액션</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="s : ${stops}">
                        <td>
                            <div th:text="${s.dayOrder}"></div>
                            <!-- 일차 합계: .00이면 소수점 제거 -->
                            <div class="muted" style="font-size:12px"
                                 th:if="${dayCost[s.dayOrder]} != null"
                                 th:with="dc=${dayCost[s.dayOrder]}, plain=${dc.remainder(BDONE).compareTo(BDZERO)==0}"
                                 th:text="'(일차 합계 ' +
                            (${plain} ? ${#numbers.formatDecimal(dc,0,'COMMA',0,'POINT')}
                                      : ${#numbers.formatDecimal(dc,0,'COMMA',2,'POINT')})
                            + '원)'"></div>
                        </td>
                        <td th:text="${s.placeName}"></td>
                        <td th:text="${s.address} ?: '-'"></td>
                        <td th:text="${s.memo} ?: '-'"></td>

                        <!-- 카테고리 표시(간단히 enum 이름) -->
                        <td th:text="${s.category != null ? s.category : 'OTHER'}"></td>

                        <!-- 개별 비용: .00이면 소수점 제거 -->
                        <td th:with="c=${s.cost != null ? s.cost : BDZERO},
                         plain=${c.remainder(BDONE).compareTo(BDZERO)==0}"
                            th:text="${plain} ? ${#numbers.formatDecimal(c,0,'COMMA',0,'POINT')}
                                  : ${#numbers.formatDecimal(c,0,'COMMA',2,'POINT')}"></td>

                        <!-- 소유자일 때만 액션 셀 자체 렌더 -->
                        <td th:if="${isOwner}">
                            <div class="row-actions">
                                <!-- 수정 버튼(모달 오픈): 현재 값 data-*로 전달 -->
                                <button class="btn"
                                        th:attr="data-id=${s.id},
                                 data-day=${s.dayOrder},
                                 data-place=${s.placeName},
                                 data-address=${s.address} ?: '',
                                 data-memo=${s.memo} ?: '',
                                 data-cost=${s.cost} ?: 0"
                                        onclick="openEditStop(this)">수정</button>

                                <button class="btn btn-danger" th:attr="data-id=${s.id}" onclick="removeStop(this)">삭제</button>
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(stops)}">
                        <!-- isOwner 여부에 따라 colspan 조정 (액션 컬럼 유무: 소유자면 7, 아니면 6) -->
                        <td th:attr="colspan=${isOwner} ? 7 : 6"
                            style="text-align:center;color:#888;">경유지가 없습니다.</td>
                    </tr>
                    </tbody>
                </table>

                <!-- 카테고리별 비용 도넛 차트 -->
                <h3 style="margin-top:16px;">카테고리별 비용</h3>
                <canvas id="costChart" width="260" height="180" style="max-width:360px; max-height:240px;"></canvas>
            </div>

            <!-- 우측: 경유지 추가 폼 (소유자만) -->
            <div>
                <h2>경유지 추가</h2>
                <div th:if="${isOwner}">
                    <form th:action="@{|/trips/${plan.id}/stops|}" method="post" th:object="${stopForm}">
                        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>
                        <div style="display:grid; gap:12px;">
                            <div>
                                <label>일차</label>
                                <input type="number" min="1" th:field="*{dayOrder}" />
                                <div class="err" th:if="${#fields.hasErrors('dayOrder')}" th:errors="*{dayOrder}"></div>
                            </div>
                            <div>
                                <label>장소명</label>
                                <input type="text" th:field="*{placeName}" placeholder="예) 도톤보리"/>
                                <div class="err" th:if="${#fields.hasErrors('placeName')}" th:errors="*{placeName}"></div>
                            </div>
                            <div>
                                <label>주소(선택)</label>
                                <input type="text" th:field="*{address}" placeholder="예) 오사카부 오사카시…"/>
                            </div>
                            <div>
                                <label>메모</label>
                                <textarea th:field="*{memo}" placeholder="추천 메뉴, 입장시간 등"></textarea>
                            </div>
                            <div>
                                <label>비용(원)</label>
                                <input type="number" step="0.01" min="0" th:field="*{cost}" placeholder="예) 12000"/>
                                <div class="err" th:if="${#fields.hasErrors('cost')}" th:errors="*{cost}"></div>
                            </div>

                            <!-- 카테고리 입력 -->
                            <div>
                                <label>분류</label>
                                <select th:field="*{category}">
                                    <option th:each="c : ${categories}" th:value="${c}" th:text="${c}"></option>
                                </select>
                                <div class="err" th:if="${#fields.hasErrors('category')}" th:errors="*{category}"></div>
                            </div>

                            <div>
                                <button class="btn btn-primary" type="submit">추가</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div th:if="${!isOwner}" class="muted">이 계획은 읽기 전용입니다.</div>
            </div>
        </div>
    </div> <!-- /with BD constants -->
</main>

<div th:replace="~{fragments/footer :: siteFooter}"></div>

<!-- 수정 모달 -->
<div id="editStopModal">
    <div class="dialog">
        <div class="dialog-header">
            <strong>경유지 수정</strong>
            <button type="button" class="btn" onclick="closeEditStop()">닫기</button>
        </div>
        <form id="editStopForm" class="dialog-body" onsubmit="saveEditStop(event)">
            <input type="hidden" name="id" />
            <div style="display:grid; gap:12px;">
                <div>
                    <label>일차</label>
                    <input type="number" name="dayOrder" min="1" required class="input"/>
                </div>
                <div>
                    <label>장소명</label>
                    <input type="text" name="placeName" required class="input" placeholder="예) 도톤보리"/>
                </div>
                <div>
                    <label>주소(선택)</label>
                    <input type="text" name="address" class="input" placeholder="예) 오사카부 오사카시…"/>
                </div>
                <div>
                    <label>메모</label>
                    <textarea name="memo" class="input" placeholder="추천 메뉴, 입장시간 등" style="min-height:80px;"></textarea>
                </div>
                <div>
                    <label>비용(원)</label>
                    <input type="number" name="cost" step="0.01" min="0" class="input" placeholder="예) 12000"/>
                </div>

                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
                    <button type="button" class="btn" onclick="closeEditStop()">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Chart.js for 도넛 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<script th:inline="javascript">
    async function removeStop(btn) {
      const id = btn.getAttribute('data-id');
      if (!confirm('삭제하시겠습니까?')) return;
      const tokenValue = /*[[${_csrf?.token}]]*/ '';
      const res = await fetch(`/trips/stops/${id}`, {
        method: 'DELETE',
        headers: { 'X-Requested-With': 'XMLHttpRequest', ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {}) }
      });
      if (res.ok) location.reload();
      else alert('삭제 실패');
    }

    // ===== 수정 모달 로직 =====
    const modal = document.getElementById('editStopModal');
    const form  = document.getElementById('editStopForm');

    function openEditStop(btn) {
      const ds = btn.dataset;
      form.id.value           = ds.id;
      form.dayOrder.value     = ds.day;
      form.placeName.value    = ds.place || '';
      form.address.value      = ds.address || '';
      form.memo.value         = ds.memo || '';
      form.cost.value         = (ds.cost !== undefined && ds.cost !== null) ? ds.cost : '';
      modal.style.display = 'block';
    }
    function closeEditStop() { modal.style.display = 'none'; }
    modal?.addEventListener('click', (e) => { if (e.target === modal) closeEditStop(); });

    async function saveEditStop(e) {
      e.preventDefault();
      const id   = form.id.value;
      const body = {
        dayOrder:   Number(form.dayOrder.value),
        placeName:  form.placeName.value?.trim(),
        address:    form.address.value?.trim() || null,
        memo:       form.memo.value?.trim() || null,
        cost:       form.cost.value === '' ? null : Number(form.cost.value)
      };

      if (!body.placeName) { alert('장소명을 입력해주세요.'); return; }
      if (!body.dayOrder || body.dayOrder < 1) { alert('일차는 1 이상의 숫자여야 합니다.'); return; }

      const tokenValue = /*[[${_csrf?.token}]]*/ '';
      try {
        const res = await fetch(`/trips/stops/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {})
          },
          body: JSON.stringify(body)
        });

        if (res.ok) {
          closeEditStop();
          location.reload();
        } else {
          const msg = await res.text();
          alert('수정 실패: ' + (msg || res.status));
        }
      } catch (err) {
        console.error(err);
        alert('네트워크 오류로 수정에 실패했습니다.');
      }
    }

    // ===== 카테고리 도넛 차트 =====
    (function() {
    // 데이터
    const labels = /*[[${catLabels}]]*/ [];
    const rawValues = /*[[${catValues}]]*/ [];
    const values = Array.isArray(rawValues) ? rawValues.map(v => Number(v) || 0) : [];

    // 캔버스 크기(작게)
    const el = document.getElementById('costChart');
    if (!el) return;
    el.width  = 320;
    el.height = 220;

    // 모든 값이 0이면 안내 표시
    const total = values.reduce((a,b)=>a+b, 0);
    if (total === 0) {
      const msg = document.createElement('div');
      msg.className = 'muted';
      msg.style.marginTop = '8px';
      msg.textContent = '카테고리별 비용 데이터가 없습니다.';
      el.replaceWith(msg);
      return;
    }

    const colors = [
      '#4C6EF5', // 교통
      '#20C997', // 숙박
      '#FD7E14', // 식사
      '#845EF7', // 관광
      '#E64980', // 쇼핑
      '#868E96'  // 기타
    ];

    const ringShadow = {
      id: 'ringShadow',
      afterDatasetsDraw(chart, args, pluginOptions) {
        const {ctx, chartArea: {top, bottom, left, right}} = chart;
        ctx.save();
        ctx.shadowColor = 'rgba(0,0,0,0.18)';
        ctx.shadowBlur = 12;
        ctx.shadowOffsetY = 6;
        ctx.shadowOffsetX = 0;
        // 링 외곽선 살짝 그려서 깊이감
        ctx.beginPath();
        const x = (left + right)/2;
        const y = (top + bottom)/2;
        const outerR = Math.min(right-left, bottom-top)/2 * 0.95;
        ctx.arc(x, y, outerR, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(0,0,0,0.08)';
        ctx.lineWidth = 4;
        ctx.stroke();
        ctx.restore();
      }
    };

    const ctx = el.getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: colors.slice(0, labels.length),
          borderColor: '#ffffff',
          borderWidth: 2,
          hoverOffset: 8
        }]
      },
      options: {
        layout: { padding: 4 },
        cutout: '68%',
        radius: '80%',
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle' } },
          tooltip: {
            callbacks: {
              label: function(context) {
                const v = Number(context.parsed) || 0;
                const isInt = Number.isInteger(v);
                const formatted = isInt
                  ? v.toLocaleString()
                  : v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                return `${context.label}: ${formatted}원`;
              }
            }
          }
        },
        animation: { animateRotate: true, duration: 600 }
      },
      plugins: [ringShadow] // 그림자 플러그인 적용
    });
  })();
</script>

</body>
</html>
