<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${plan.title} + ' - 상세'">여행 상세</title>
    <link rel="stylesheet" th:href="@{/css/base.css}" />
    <style>
        /* 모달 기본 스타일 */
        #editStopModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999; }
        #editStopModal .dialog {
          background:#fff; width:520px; max-width:calc(100% - 24px);
          margin:10vh auto; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15); overflow:hidden;
        }
        #editStopModal .dialog-header {
          padding:14px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;
        }
        #editStopModal .dialog-body { padding:16px; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: siteHeader('trips')}"></div>

<main class="wrap">
    <div th:with="BDONE=${T(java.math.BigDecimal).ONE}, BDZERO=${T(java.math.BigDecimal).ZERO}">
        <div class="top">
            <div>
                <h1 th:text="${plan.title}">여행 제목</h1>
                <div class="muted" th:text="${plan.startDate} + ' ~ ' + ${plan.endDate}"></div>
                <div class="muted">
                    작성자:
                    <span th:text="${plan.owner != null && plan.owner.name != null ? plan.owner.name : (plan.owner != null ? plan.owner.username : '알 수 없음')}"></span>
                </div>
            </div>
            <div class="top">
                <a class="btn" th:href="@{/trips}">목록</a>
                <div th:if="${isOwner}">
                    <form th:action="@{|/trips/${plan.id}/delete|}" method="post" onsubmit="return confirm('정말 삭제하시겠습니까?');">
                        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>
                        <button type="submit" class="btn btn-danger">계획 삭제</button>
                    </form>
                </div>
            </div>
        </div>

        <div th:if="${msg}" class="msg" th:text="${msg}"></div>

        <div class="grid" style="grid-template-columns: 2fr 1fr; gap:16px;">
            <!-- 좌측: 경유지 목록 -->
            <section>
                <h2>경유지 목록</h2>

                <div class="muted" th:with="plain=${totalCost != null and totalCost.remainder(BDONE).compareTo(BDZERO)==0}">
                    총 비용:
                    <b th:text="${plain} ? ${#numbers.formatDecimal(totalCost,0,'COMMA',0,'POINT')} : ${#numbers.formatDecimal(totalCost,0,'COMMA',2,'POINT')}"></b> 원
                </div>

                <table>
                    <thead>
                    <tr>
                        <th style="width:80px;">일차</th>
                        <th>장소명</th>
                        <th>주소</th>
                        <th>메모</th>
                        <th style="width:100px;">분류</th>
                        <th style="width:120px;">비용</th>
                        <th th:if="${isOwner}" style="width:180px;">액션</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="s : ${stops}">
                        <td>
                            <div th:text="${s.dayOrder}"></div>
                            <div class="muted" th:if="${dayCost[s.dayOrder]} != null"
                                 th:with="dc=${dayCost[s.dayOrder]}, plain=${dc.remainder(BDONE).compareTo(BDZERO)==0}"
                                 th:text="'(일차 합계 ' + (${plain} ? ${#numbers.formatDecimal(dc,0,'COMMA',0,'POINT')} : ${#numbers.formatDecimal(dc,0,'COMMA',2,'POINT')}) + '원)'"></div>
                        </td>
                        <td th:text="${s.placeName}"></td>
                        <td th:text="${s.address} ?: '-'"></td>
                        <td th:text="${s.memo} ?: '-'"></td>
                        <td th:text="${s.category != null ? s.category : 'OTHER'}"></td>
                        <td th:with="c=${s.cost != null ? s.cost : BDZERO}, plain=${c.remainder(BDONE).compareTo(BDZERO)==0}"
                            th:text="${plain} ? ${#numbers.formatDecimal(c,0,'COMMA',0,'POINT')} : ${#numbers.formatDecimal(c,0,'COMMA',2,'POINT')}"></td>
                        <td th:if="${isOwner}">
                            <div class="top">
                                <button class="btn" th:attr="data-id=${s.id}, data-day=${s.dayOrder}, data-place=${s.placeName}, data-address=${s.address} ?: '', data-memo=${s.memo} ?: '', data-cost=${s.cost} ?: 0" onclick="openEditStop(this)">수정</button>
                                <button class="btn btn-danger" th:attr="data-id=${s.id}" onclick="removeStop(this)">삭제</button>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(stops)}">
                        <td th:attr="colspan=${isOwner} ? 7 : 6" class="muted" style="text-align:center;">경유지가 없습니다.</td>
                    </tr>
                    </tbody>
                </table>

                <h3 class="section-title" style="margin-top:12px;">카테고리별 비용</h3>
                <canvas id="costChart" width="320" height="220"></canvas>
            </section>

            <!-- 우측: 경유지 추가 -->
            <section>
                <h2>경유지 추가</h2>

                <div th:if="${isOwner}">
                    <form th:action="@{|/trips/${plan.id}/stops|}" method="post" th:object="${stopForm}">
                        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

                        <div class="grid">
                            <div class="form-row">
                                <label>일차</label>
                                <input type="number" min="1" th:field="*{dayOrder}" />
                                <div class="err" th:if="${#fields.hasErrors('dayOrder')}" th:errors="*{dayOrder}"></div>
                            </div>
                            <div class="form-row">
                                <label>장소명</label>
                                <input type="text" th:field="*{placeName}" placeholder="예) 도톤보리"/>
                                <div class="err" th:if="${#fields.hasErrors('placeName')}" th:errors="*{placeName}"></div>
                            </div>
                            <div class="form-row">
                                <label>주소(선택)</label>
                                <input type="text" th:field="*{address}" placeholder="예) 오사카부 오사카시…"/>
                            </div>
                            <div class="form-row">
                                <label>메모</label>
                                <textarea th:field="*{memo}" placeholder="추천 메뉴, 입장시간 등"></textarea>
                            </div>
                            <div class="form-row">
                                <label>비용(원)</label>
                                <input type="number" step="0.01" min="0" th:field="*{cost}" placeholder="예) 12000"/>
                                <div class="err" th:if="${#fields.hasErrors('cost')}" th:errors="*{cost}"></div>
                            </div>
                            <div class="form-row">
                                <label>분류</label>
                                <select th:field="*{category}">
                                    <option th:each="c : ${categories}" th:value="${c}" th:text="${c}"></option>
                                </select>
                                <div class="err" th:if="${#fields.hasErrors('category')}" th:errors="*{category}"></div>
                            </div>
                            <div>
                                <button class="btn btn-primary" type="submit">추가</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div th:if="${!isOwner}" class="muted">이 계획은 읽기 전용입니다.</div>
            </section>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: siteFooter}"></div>

<!-- 수정 모달 -->
<div id="editStopModal" class="modal">
    <div class="modal__dialog">
        <div class="modal__header">
            <strong>경유지 수정</strong>
            <button type="button" class="btn" onclick="closeEditStop()">닫기</button>
        </div>
        <form id="editStopForm" class="modal__body" onsubmit="saveEditStop(event)">
            <input type="hidden" name="id" />
            <div class="grid">
                <div class="form-row">
                    <label>일차</label>
                    <input type="number" name="dayOrder" min="1" required />
                </div>
                <div class="form-row">
                    <label>장소명</label>
                    <input type="text" name="placeName" required placeholder="예) 도톤보리"/>
                </div>
                <div class="form-row">
                    <label>주소(선택)</label>
                    <input type="text" name="address" placeholder="예) 오사카부 오사카시…"/>
                </div>
                <div class="form-row">
                    <label>메모</label>
                    <textarea name="memo" placeholder="추천 메뉴, 입장시간 등" style="min-height:80px;"></textarea>
                </div>
                <div class="form-row">
                    <label>비용(원)</label>
                    <input type="number" name="cost" step="0.01" min="0" placeholder="예) 12000"/>
                </div>
                <div class="top" style="justify-content:flex-end;">
                    <button type="button" class="btn" onclick="closeEditStop()">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script th:inline="javascript">
    async function removeStop(btn) {
      const id = btn.getAttribute('data-id');
      if (!confirm('삭제하시겠습니까?')) return;
      const tokenValue = /*[[${_csrf?.token}]]*/ '';
      const res = await fetch(`/trips/stops/${id}`, {
        method: 'DELETE',
        headers: { 'X-Requested-With': 'XMLHttpRequest', ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {}) }
      });
      if (res.ok) location.reload();
      else alert('삭제 실패');
    }

    const modal = document.getElementById('editStopModal');
    const form  = document.getElementById('editStopForm');

    function openEditStop(btn) {
      const ds = btn.dataset;
      form.id.value        = ds.id;
      form.dayOrder.value  = ds.day;
      form.placeName.value = ds.place || '';
      form.address.value   = ds.address || '';
      form.memo.value      = ds.memo || '';
      form.cost.value      = (ds.cost !== undefined && ds.cost !== null) ? ds.cost : '';
      modal.style.display = 'block';
    }
    function closeEditStop() { modal.style.display = 'none'; }
    modal?.addEventListener('click', (e) => { if (e.target === modal) closeEditStop(); });

    async function saveEditStop(e) {
      e.preventDefault();
      const id   = form.id.value;
      const body = {
        dayOrder:  Number(form.dayOrder.value),
        placeName: form.placeName.value?.trim(),
        address:   form.address.value?.trim() || null,
        memo:      form.memo.value?.trim() || null,
        cost:      form.cost.value === '' ? null : Number(form.cost.value)
      };
      if (!body.placeName) { alert('장소명을 입력해주세요.'); return; }
      if (!body.dayOrder || body.dayOrder < 1) { alert('일차는 1 이상의 숫자여야 합니다.'); return; }

      const tokenValue = /*[[${_csrf?.token}]]*/ '';
      try {
        const res = await fetch(`/trips/stops/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            ...(tokenValue ? {'X-CSRF-TOKEN': tokenValue} : {})
          },
          body: JSON.stringify(body)
        });
        if (res.ok) { closeEditStop(); location.reload(); }
        else { const msg = await res.text(); alert('수정 실패: ' + (msg || res.status)); }
      } catch (err) {
        console.error(err);
        alert('네트워크 오류로 수정에 실패했습니다.');
      }
    }

    (function() {
      const labels = /*[[${catLabels}]]*/ [];
      const rawValues = /*[[${catValues}]]*/ [];
      const values = Array.isArray(rawValues) ? rawValues.map(v => Number(v) || 0) : [];
      const el = document.getElementById('costChart');
      if (!el) return;

      const total = values.reduce((a,b)=>a+b, 0);
      if (total === 0) {
        const msg = document.createElement('div');
        msg.className = 'muted';
        msg.style.marginTop = '8px';
        msg.textContent = '카테고리별 비용 데이터가 없습니다.';
        el.replaceWith(msg);
        return;
      }

      const colors = ['#4C6EF5','#20C997','#FD7E14','#845EF7','#E64980','#868E96'];
      const ringShadow = {
        id: 'ringShadow',
        afterDatasetsDraw(chart) {
          const {ctx, chartArea: {top, bottom, left, right}} = chart;
          ctx.save();
          ctx.shadowColor = 'rgba(0,0,0,0.18)';
          ctx.shadowBlur = 12; ctx.shadowOffsetY = 6;
          const x = (left + right)/2, y = (top + bottom)/2;
          const outerR = Math.min(right-left, bottom-top)/2 * 0.95;
          ctx.beginPath(); ctx.arc(x, y, outerR, 0, Math.PI*2);
          ctx.strokeStyle = 'rgba(0,0,0,0.08)'; ctx.lineWidth = 4; ctx.stroke();
          ctx.restore();
        }
      };

      const ctx = el.getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderColor:'#fff', borderWidth:2, hoverOffset:8 }] },
        options: {
          layout: { padding: 4 }, cutout:'68%', radius:'80%',
          plugins: {
            legend: { position:'bottom', labels:{ usePointStyle:true, pointStyle:'circle' } },
            tooltip: { callbacks: {
              label: (c) => {
                const v = Number(c.parsed) || 0;
                const isInt = Number.isInteger(v);
                const f = isInt ? v.toLocaleString() : v.toLocaleString(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 });
                return `${c.label}: ${f}원`;
              }
            }}
          }, animation: { animateRotate:true, duration:600 }
        },
        plugins: [ringShadow]
      });
    })();
</script>
</body>
</html>
